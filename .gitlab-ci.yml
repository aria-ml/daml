workflow:
  # Allows jobs in this workflow to be interrupted:
  # https://gitlab.jatic.net/help/ci/yaml/index.md#workflowauto_cancelon_new_commit
  auto_cancel:
    on_new_commit: interruptible
  rules:
    # Release workflow
    # - TODO: update workflow to run docs and update .jupyter_cache
    # - release[create release]
    - if: $CI_PIPELINE_SOURCE == 'schedule' && $CREATE_NEW_RELEASE

    # Skip on CHANGELOG.md updates
    - if: $CI_COMMIT_BRANCH == 'main'
      changes: ["CHANGELOG.md"]
      when: never

    # Merge Request workflow
    # - build[build base, build image, verify lock]
    # - test[linting, dependency test, unit test, coverage, docs]
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

    # Main Branch commit workflow
    # - TODO: remove release[pages] if permissible
    # - build[build base, build image, verify lock]
    # - test[linting, dependency test, functional test, coverage, docs]
    # - release[pages, tag release candidate]
    - if: $CI_COMMIT_BRANCH == 'main'

default:
  # This should allow pipelines to auto-cancel when redundant:
  # https://gitlab.jatic.net/help/ci/pipelines/settings.md#auto-cancel-redundant-pipelines
  # https://gitlab.jatic.net/help/ci/yaml/index.md#interruptible
  interruptible: true
  tags:
    - autoscaler

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHON_LATEST_SUPPORTED_VERSION: "3.11"
  DOCKER_DRIVER: overlay2

image: python:$PYTHON_LATEST_SUPPORTED_VERSION

cache:
  paths:
    - .cache/pip
    - venv/

stages:
  - build
  - test
  - publish
  - release

include:
  - local: '.gitlab-ci/*.yml'
