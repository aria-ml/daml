workflow:
  # Allows jobs in this workflow to be interrupted:
  # https://gitlab.jatic.net/help/ci/yaml/index.md#workflowauto_cancelon_new_commit
  auto_cancel:
    on_new_commit: interruptible
  rules:
    - if: $CI_COMMIT_BRANCH == 'main'
      changes: ["CHANGELOG.md"]
      when: never

default:
  # This should allow pipelines to auto-cancel when redundant:
  # https://gitlab.jatic.net/help/ci/pipelines/settings.md#auto-cancel-redundant-pipelines
  # https://gitlab.jatic.net/help/ci/yaml/index.md#interruptible
  interruptible: true
  tags:
    - autoscaler

stages:
  - build
  - test
  - publish
  - release

include:
  - '.gitlab-ci/build.yaml'
  - '.gitlab-ci/test-publish.yaml'
  - '.gitlab-ci/release.yaml'

image: python:$PYTHON_LATEST_SUPPORTED_VERSION

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHON_LATEST_SUPPORTED_VERSION: "3.11"
  DOCKER_DRIVER: overlay2

cache:
  paths:
    - .cache/pip
    - venv/

include:
 - template: Security/Secret-Detection.gitlab-ci.yml
#  - template: Security/Dependency-Scanning.gitlab-ci.yml
#  - template: Security/SAST.gitlab-ci.yml

secret_detection:
  needs: []
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'main'

# generate shipped dependencies:
#   stage: build
#   before_script:
#     - pip install poetry
#     - poetry check
#     - poetry self add poetry-lock-groups-plugin
#   script:
#     - poetry lock --without test,lint,docs
#   artifacts:
#     paths:
#       - poetry.lock
#   rules:
#     - if: $CI_COMMIT_REF_PROTECTED == "true"
#     - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'main'

# gemnasium-python-dependency_scanning:
#   needs:
#     - job: generate shipped dependencies
#       artifacts: true
#   # Both `needs` and `dependencies` are used due to a quirk of gitlab.
#   # `gemnasium-python-dependency_scanning` specifies an empty list of
#   # dependencies, which means that unless you explicitly add the dependency,
#   # all artifacts will be filtered out and removed from this job.
#   dependencies:
#     - generate shipped dependencies
#   rules:
#     - if: $CI_COMMIT_REF_PROTECTED == "true"
#     - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'main'

# semgrep-sast:
#   needs: []
#   rules:
#     - if: $CI_COMMIT_REF_PROTECTED == "true"
#     - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'main'
