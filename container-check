#!/bin/bash -e
LANG=C

function docker_build() {
    temp=$(mktemp)
    docker build --build-arg python_version=$1 --tag daml-$2-$1 --target $2 . &> $temp || result="FAILED"

    echo -n "-> Python ${1} - ${2}: "
    if [[ $result == "FAILED" ]]; then
        log_file="daml-${2}-${1}_failure_$(date +%s).log"
        echo "FAILED (see log file ${log_file})"
        cat $temp > $log_file
    else
        echo SUCCEEDED
    fi
    rm $temp
}

export -f docker_build

echo "Building containers..."
parallel docker_build ::: 3.8 3.9 3.10 3.11 ::: type lint unit
